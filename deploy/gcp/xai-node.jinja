resources:
- name: xai-node-instance
  type: compute.v1.instance
  properties:
    zone: {{ properties['zone'] }}
    machineType: zones/{{ properties['zone'] }}/machineTypes/{{ properties['machineType'] }}
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: false
      initializeParams:
        sourceImage: projects/ubuntu-os-cloud/global/images/family/ubuntu-2204-lts
        diskType: zones/{{ properties['zone'] }}/diskTypes/pd-ssd
        diskSizeGb: {{ properties['diskSizeGb'] }}
    networkInterfaces:
    - network: global/networks/default
      accessConfigs:
      - name: External NAT
        type: ONE_TO_ONE_NAT
    tags:
      items:
      - xai-node
      - blockchain
    metadata:
      items:
      - key: startup-script
        value: |
          #!/bin/bash
          set -e

          # Update system
          apt-get update
          apt-get upgrade -y

          # Install Docker
          curl -fsSL https://get.docker.com -o get-docker.sh
          sh get-docker.sh
          systemctl enable docker
          systemctl start docker

          # Install Docker Compose
          curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose

          # Clone XAI
          apt-get install -y git
          mkdir -p /opt/xai
          cd /opt/xai
          git clone https://github.com/xai-blockchain/xai.git .

          # Configure environment
          cat > .env <<EOF
          XAI_NETWORK={{ properties['networkMode'] }}
          XAI_ENV=production
          XAI_API_PORT=8080
          XAI_NODE_PORT=8333
          XAI_METRICS_PORT=9090
          POSTGRES_PASSWORD=$(openssl rand -hex 32)
          EOF

          # Start node
          cd docker/testnet
          docker-compose -f docker-compose.one-node.yml up -d

          # Setup systemd service
          cat > /etc/systemd/system/xai-node.service <<SERVICEEOF
          [Unit]
          Description=XAI Blockchain Node
          After=docker.service
          Requires=docker.service

          [Service]
          Type=oneshot
          RemainAfterExit=yes
          WorkingDirectory=/opt/xai/docker/testnet
          ExecStart=/usr/local/bin/docker-compose -f docker-compose.one-node.yml up -d
          ExecStop=/usr/local/bin/docker-compose -f docker-compose.one-node.yml down

          [Install]
          WantedBy=multi-user.target
          SERVICEEOF

          systemctl daemon-reload
          systemctl enable xai-node

          # Install Stackdriver
          curl -sSO https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.sh
          bash add-google-cloud-ops-agent-repo.sh --also-install

          echo "XAI Node deployed successfully"

    serviceAccounts:
    - email: default
      scopes:
      - https://www.googleapis.com/auth/cloud-platform
      - https://www.googleapis.com/auth/logging.write
      - https://www.googleapis.com/auth/monitoring.write

- name: xai-node-firewall
  type: compute.v1.firewall
  properties:
    network: global/networks/default
    sourceRanges:
    - 0.0.0.0/0
    allowed:
    - IPProtocol: TCP
      ports:
      - "22"
      - "8080"
      - "8333"
      - "9090"
      - "3000"
    targetTags:
    - xai-node

outputs:
- name: instanceName
  value: $(ref.xai-node-instance.name)
- name: externalIP
  value: $(ref.xai-node-instance.networkInterfaces[0].accessConfigs[0].natIP)
- name: apiURL
  value: http://$(ref.xai-node-instance.networkInterfaces[0].accessConfigs[0].natIP):8080
- name: explorerURL
  value: http://$(ref.xai-node-instance.networkInterfaces[0].accessConfigs[0].natIP):3000
