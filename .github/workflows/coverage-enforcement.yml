name: Coverage Enforcement & Reporting

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.11'
  COVERAGE_THRESHOLD: 98

jobs:
  coverage-check:
    name: Check Test Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest \
            --cov=src \
            --cov-report=json \
            --cov-report=html \
            --cov-report=xml \
            --cov-report=term-missing:skip-covered \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}
        continue-on-error: true

      - name: Generate coverage badge
        run: |
          python scripts/coverage_tools/coverage_badge_generator.py \
            --coverage-file coverage.json \
            --output badges/coverage.svg \
            --update-readme

      - name: Find uncovered lines
        if: always()
        run: |
          python scripts/coverage_tools/find_uncovered_lines.py \
            --coverage-file coverage.json \
            --show-code \
            --output coverage_report.txt
        continue-on-error: true

      - name: Monitor coverage
        if: always()
        run: |
          python scripts/coverage_tools/coverage_monitor.py \
            --record \
            --coverage-file coverage.json

      - name: Check coverage vs main
        if: github.event_name == 'pull_request'
        run: |
          python scripts/coverage_tools/coverage_monitor.py \
            --compare main \
            --verbose
        continue-on-error: true

      - name: Comment PR with coverage report
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage.json', 'utf8'));
            const totals = coverage.totals;

            const coveragePercent = totals.percent_covered.toFixed(2);
            const color = coveragePercent >= 98 ? '✅' : coveragePercent >= 95 ? '⚠️' : '❌';

            const comment = `## Coverage Report

${color} **Total Coverage: ${coveragePercent}%**

- **Statements**: ${totals.executed_lines}/${totals.num_statements}
- **Missing**: ${totals.num_statements - totals.executed_lines} lines
- **Threshold**: ${process.env.COVERAGE_THRESHOLD}%
- **Status**: ${coveragePercent >= process.env.COVERAGE_THRESHOLD ? '✅ PASS' : '❌ FAIL'}

${fs.existsSync('coverage_report.txt') ? '### Uncovered Lines\n\`\`\`\n' + fs.readFileSync('coverage_report.txt', 'utf8').substring(0, 1000) + '\n\`\`\`' : ''}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: |
            coverage.json
            coverage.xml
            htmlcov/
            coverage_report.txt
            badges/coverage.svg

      - name: Upload coverage badge
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-badge
          path: badges/coverage.svg

      - name: Generate HTML coverage trend
        if: always()
        run: |
          python scripts/coverage_tools/coverage_monitor.py \
            --html coverage_trend.html

      - name: Fail if coverage below threshold
        if: always()
        run: |
          python scripts/coverage_tools/coverage_monitor.py \
            --check \
            --threshold ${{ env.COVERAGE_THRESHOLD }}

  coverage-trend:
    name: Coverage Trend Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Generate coverage trend report
        run: |
          python scripts/coverage_tools/coverage_monitor.py \
            --report \
            --html coverage_trend_$(date +%Y%m%d).html

      - name: Upload trend report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-trend-report
          path: coverage_trend_*.html

  pr-enforcement:
    name: PR Coverage Enforcement
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check coverage didn't decrease
        run: |
          git fetch origin main
          python scripts/coverage_tools/coverage_monitor.py \
            --compare main \
            --verbose
        continue-on-error: true

      - name: Enforce 98% coverage
        run: |
          python -m pytest \
            --cov=src \
            --cov-report=term \
            --cov-fail-under=98 \
            -q
        continue-on-error: true

  code-coverage-badge:
    name: Generate Coverage Badge
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Generate badge
        run: |
          mkdir -p badges
          python scripts/coverage_tools/coverage_badge_generator.py \
            --all \
            --threshold ${{ env.COVERAGE_THRESHOLD }}

      - name: Commit badge
        run: |
          git config user.name "Coverage Bot"
          git config user.email "coverage-bot@project.local"
          git add badges/coverage.svg README.md
          git commit -m "chore: update coverage badge [skip ci]" || echo "No changes to commit"
          git push || echo "Nothing to push"
        continue-on-error: true

  security-coverage:
    name: Security & Coverage Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Check security module coverage
        run: |
          python -m pytest \
            --cov=src/xai/core/security \
            --cov=src/xai/core/blockchain_security \
            --cov=src/xai/core/p2p_security \
            --cov-fail-under=99 \
            -v

      - name: Generate security coverage report
        if: always()
        run: |
          python scripts/coverage_tools/find_uncovered_lines.py \
            --coverage-file coverage.json \
            --module security \
            --show-code \
            --output security_coverage_report.txt
