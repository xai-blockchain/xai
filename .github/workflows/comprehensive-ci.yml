name: Comprehensive CI/CD Pipeline

on:
  push:
    branches: ["**"]  # Run on every push to any branch
  pull_request:
    branches: ["**"]

permissions:
  contents: read
  security-events: write
  actions: read
  checks: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # LINTING - All Code Quality Checks
  # ============================================================================
  lint-python:
    name: Python Linters
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Black (formatter check)
        run: black --check --diff .

      - name: Run isort (import sorting)
        run: isort --check-only --diff .

      - name: Run Flake8
        run: flake8 src/ tests/

      - name: Run Pylint
        run: pylint src/ --exit-zero --output-format=colorized

      - name: Run MyPy (type checking)
        run: mypy src/

  lint-javascript:
    name: JavaScript/TypeScript Linters
    runs-on: ubuntu-latest
    if: hashFiles('package.json') != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Run ESLint
        run: npx eslint . --ext .js,.jsx,.ts,.tsx || true

      - name: Run Prettier check
        run: npx prettier --check . || true

  # ============================================================================
  # STATIC ANALYSIS - Security & Code Quality
  # ============================================================================
  static-analysis:
    name: Static Analysis & Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Bandit (security)
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f screen

      - name: Run Semgrep
        run: |
          pip install semgrep
          semgrep --config=auto --json --output=semgrep-report.json . || true
          semgrep --config=auto .

      - name: Run pip-audit (dependency check)
        run: |
          pip-audit --format json --output pip-audit-report.json || true
          pip-audit

      - name: Run Safety (dependency security)
        run: |
          safety check --json --output safety-report.json || true
          safety check || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-python
          path: |
            bandit-report.json
            semgrep-report.json
            pip-audit-report.json
            safety-report.json

  sonarqube-scan:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        continue-on-error: true

  # ============================================================================
  # UNIT TESTS
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run unit tests with coverage
        run: |
          pytest tests/ -v \
            -m "unit or not integration" \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=junit-unit.xml

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports-unit
          path: |
            coverage.xml
            htmlcov/
            junit-unit.xml

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: unit-test-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  # ============================================================================
  # INTEGRATION TESTS
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run integration tests
        run: |
          pytest tests/ -v \
            -m "integration" \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing \
            --junitxml=junit-integration.xml \
            --timeout=300

      - name: Upload integration test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports-integration
          path: |
            coverage.xml
            junit-integration.xml

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: integration
          name: integration-test-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  # ============================================================================
  # FUZZ TESTING - 60 seconds
  # ============================================================================
  fuzz-tests:
    name: Fuzz Testing (60s)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install hypothesis atheris

      - name: Run Hypothesis fuzz tests (60 seconds)
        run: |
          timeout 60 pytest tests/ -v \
            -m "fuzz or property" \
            --hypothesis-profile=ci \
            --hypothesis-seed=0 \
            || echo "Fuzz testing completed (60s timeout reached or tests passed)"

      - name: Upload fuzz test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fuzz-test-results
          path: .hypothesis/

  # ============================================================================
  # E2E TESTS
  # ============================================================================
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    if: hashFiles('tests/e2e/**') != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run E2E tests
        run: |
          pytest tests/e2e/ -v \
            --junitxml=junit-e2e.xml \
            --timeout=600

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: junit-e2e.xml

  # ============================================================================
  # SUMMARY
  # ============================================================================
  ci-summary:
    name: CI Pipeline Summary
    runs-on: ubuntu-latest
    needs:
      - lint-python
      - lint-javascript
      - static-analysis
      - unit-tests
      - integration-tests
      - fuzz-tests
    if: always()
    steps:
      - name: Check results
        run: |
          echo "# CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Linting" >> $GITHUB_STEP_SUMMARY
          echo "- Python Linters: ${{ needs.lint-python.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript Linters: ${{ needs.lint-javascript.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Static Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scanning: ${{ needs.static-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Testing" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Fuzz Tests (60s): ${{ needs.fuzz-tests.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: |
          needs.lint-python.result == 'failure' ||
          needs.static-analysis.result == 'failure' ||
          needs.unit-tests.result == 'failure' ||
          needs.integration-tests.result == 'failure'
        run: |
          echo "::error::One or more critical jobs failed"
          exit 1
