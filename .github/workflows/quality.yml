name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-quality-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-quality-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black pylint mypy
        if [ -f src/xai/requirements.txt ]; then pip install -r src/xai/requirements.txt; fi
        if [ -f tests/xai_tests/requirements_test.txt ]; then pip install -r tests/xai_tests/requirements_test.txt; fi

    - name: Run Black formatter check
      run: |
        black --check --diff src/ tests/ scripts/
      continue-on-error: false

    - name: Run Pylint
      run: |
        pylint src/xai/core/ --rcfile=.pylintrc || true
        pylint src/xai/*.py --rcfile=.pylintrc || true
      continue-on-error: true

    - name: Run MyPy type checking
      run: |
        mypy src/xai/core/ --ignore-missing-imports --no-strict-optional
        mypy src/xai/*.py --ignore-missing-imports --no-strict-optional
      continue-on-error: true

    - name: Check code complexity
      run: |
        pip install radon
        radon cc src/ -a -nb
        radon mi src/ -nb
      continue-on-error: true

    - name: Generate quality report
      if: always()
      run: |
        echo "## Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Checks Completed:" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Black formatting" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Pylint analysis" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ MyPy type checking" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Code complexity analysis" >> $GITHUB_STEP_SUMMARY

  documentation-quality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check markdown files
      uses: DavidAnson/markdownlint-cli2-action@v18
      with:
        globs: '**/*.md'
      continue-on-error: true

    - name: Check for broken links in docs
      run: |
        npm install -g markdown-link-check
        find docs -name "*.md" -exec markdown-link-check {} \;
      continue-on-error: true

  commit-quality:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install commitlint
      run: |
        npm install -g @commitlint/cli @commitlint/config-conventional

    - name: Validate commit messages
      run: |
        npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
      continue-on-error: true
